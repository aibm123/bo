<!DOCTYPE html>
<html lang="vi" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent & Digital Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --background: #111827; /* gray-900 */
            --card-bg: #1f2937;    /* gray-800 */
            --border: #374151;    /* gray-700 */
            --input-bg: #374151;  /* gray-700 */
            --input-border: #4b5563; /* gray-600 */
            --text-primary: #f9fafb;   /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --primary: #6366f1; /* indigo-500 */
            --primary-hover: #4f46e5; /* indigo-600 */
        }
        /* Make the entire page structure based on flexbox for better responsiveness */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }
        /* General styles */
        .tab-btn.active { border-color: var(--primary); color: var(--primary); }
        .dashboard-tab-btn.active { background-color: var(--primary); color: white; }
        .chat-bubble-user { background-color: var(--primary); color: white; }
        .chat-bubble-ai { background-color: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border); }
        .typing-dot { animation: typing-pulse 1.5s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-pulse {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        .image-upload-area { border: 2px dashed var(--border); }
        .image-upload-area.dragover { border-color: var(--primary); background-color: rgba(99, 102, 241, 0.1); }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; }
        .card { background-color: var(--card-bg); border-radius: 0.75rem; border: 1px solid var(--border); }
        .input-field { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary); }
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); }
        .list-item { cursor: pointer; transition: background-color 0.2s; }
        .list-item:hover { background-color: #374151; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .status-published { background-color: #10b981; color: #ffffff; }
        .status-draft { background-color: #6b7280; color: #ffffff; }

        /* Main app layout fix for responsiveness and keyboard handling */
        #view-app {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        main {
            flex-grow: 1;
            overflow-y: auto; /* Allow main content to scroll if needed */
            padding: 1.5rem;
        }
        /* Specific fix for chat view to handle mobile keyboard */
        #view-chatbot.flex {
            display: flex;
            flex-direction: column;
            height: 100%; /* Take full height of its parent (main) */
            padding: 0 !important; /* Remove padding from parent if it's the chat view */
        }
        .chat-container {
             display: flex;
             flex-direction: column;
             height: 100%; /* Full height of its container */
             width: 100%;
             max-width: 1280px; /* Optional: limit max width on large screens */
             margin: 0 auto;
        }
        #chat-messages {
            flex-grow: 1; /* This is the key: makes the message area take all available space */
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="view-login" class="flex items-center justify-center min-h-full p-4">
        <div class="w-full max-w-md space-y-6">
            <div class="card p-8 space-y-6">
                 <div class="text-center">
                    <h1 class="text-2xl font-bold text-white">AI BIZ OWNER</h1>
                 </div>
                <form class="space-y-4">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-gray-300">Email</label>
                        <input type="email" id="login-email" class="w-full px-3 py-2 mt-1 rounded-md shadow-sm input-field" placeholder="Nhập email của bạn">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-gray-300">Mật khẩu</label>
                        <input type="password" id="login-password" class="w-full px-3 py-2 mt-1 rounded-md shadow-sm input-field" placeholder="Nhập mật khẩu">
                    </div>
                    <button type="button" id="login-btn" class="w-full py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md shadow-sm">Đăng nhập</button>
                </form>
                <p id="login-error" class="text-sm text-center text-red-400 mt-2 hidden"></p>
            </div>

            <div class="card p-6 text-sm text-gray-300 space-y-4">
                <div>
                    <h3 class="font-semibold text-white">Tài khoản admin & user chung:</h3>
                    <p>admin@gmail.com / 123</p>
                    <p>user@gmail.com / 123</p>
                </div>
                 <div>
                    <h3 class="font-semibold text-white">Danh sách Apps mở rộng:</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><a href="https://sis.aibm.space" target="_blank" class="text-indigo-400 hover:underline">SIS cho trung tâm đào tạo</a></li>
                        <li><a href="https://his.aibm.space" target="_blank" class="text-indigo-400 hover:underline">HIS cho phòng khám tư</a></li>
                    </ul>
                </div>
                 <div>
                    <h3 class="font-semibold text-white">Link database chung & tài khoản:</h3>
                    <p><a href="https://aibm.store/workspace/164" target="_blank" class="text-indigo-400 hover:underline">https://aibm.store/workspace/164</a></p>
                    <p>realtrendasia@gmail.com / aibizmanager</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App View -->
    <div id="view-app" class="hidden">
        <header class="flex flex-col md:flex-row justify-between items-start mb-4 px-6 pt-6 flex-shrink-0">
            <div>
                <h1 class="text-xl md:text-3xl font-bold text-white">AI Agent & Digital Dashboard</h1>
                <p class="text-gray-400 mt-1 text-sm md:text-base">Phân tích hiệu suất và trò chuyện với AI.</p>
            </div>
            <button id="logout-btn" class="mt-4 md:mt-0 flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md shadow-sm">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Đăng xuất</span>
            </button>
        </header>

         <div class="border-b border-gray-700 px-6 flex-shrink-0">
            <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                <button id="tab-chatbot" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-white border-transparent">Chatbot</button>
                <button id="tab-dashboard" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-white border-transparent">Tổng quan</button>
                <button id="tab-bai-viet" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-white border-transparent">Bài viết</button>
                <button id="tab-dinh-ky" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-400 hover:text-white border-transparent">Định kỳ</button>
            </nav>
        </div>

        <main>
            <!-- Dashboard View -->
            <div id="view-dashboard" class="hidden space-y-6">
                <div class="card">
                     <div class="p-4 border-b border-gray-700">
                         <nav class="flex space-x-2 overflow-x-auto" aria-label="Dashboard Tabs">
                             <button data-tab="product" class="dashboard-tab-btn active px-4 py-2 text-sm font-medium rounded-md">Product</button>
                             <button data-tab="character" class="dashboard-tab-btn px-4 py-2 text-sm font-medium text-gray-300 rounded-md">Character</button>
                             <button data-tab="segment" class="dashboard-tab-btn px-4 py-2 text-sm font-medium text-gray-300 rounded-md">Segment</button>
                         </nav>
                     </div>
                     <div class="p-6">
                         <!-- Product Tab -->
                         <div id="dashboard-tab-content-product" class="dashboard-tab-content space-y-6">
                            <!-- Content is rendered by JS -->
                         </div>
                         <!-- Character Tab -->
                         <div id="dashboard-tab-content-character" class="dashboard-tab-content hidden space-y-6">
                            <!-- Content is rendered by JS -->
                         </div>
                         <!-- Segment Tab -->
                          <div id="dashboard-tab-content-segment" class="dashboard-tab-content hidden space-y-6">
                             <!-- Content is rendered by JS -->
                         </div>
                     </div>
                </div>
                 <!-- Legacy Dashboard for KPIs and Charts -->
                <div id="legacy-dashboard-content">
                    <!-- Content is rendered by JS -->
                </div>
            </div>
            
            <!-- Articles (Bài viết) View -->
            <div id="view-bai-viet" class="hidden">
                 <div id="bai-viet-list-view">
                    <!-- Content is rendered by JS -->
                </div>
                <div id="bai-viet-detail-view" class="hidden">
                    <!-- Content is rendered by JS -->
                </div>
            </div>
            
            <!-- Recurring (Định kỳ) View -->
            <div id="view-dinh-ky" class="hidden">
                 <div id="dinh-ky-list-view">
                    <!-- Content is rendered by JS -->
                </div>
                 <div id="dinh-ky-detail-view" class="hidden">
                    <!-- Content is rendered by JS -->
                </div>
            </div>

            <!-- Chatbot View -->
            <div id="view-chatbot" class="hidden">
                 <div class="chat-container">
                    <div id="chat-messages" class="p-4 space-y-4">
                         <!-- Initial welcome message -->
                         <div class="flex justify-start">
                            <div class="chat-bubble-ai p-3 rounded-lg max-w-lg prose prose-invert">Xin chào! Tôi là AI Agent.</div>
                         </div>
                    </div>
                    <div class="p-4 border-t border-gray-700 flex-shrink-0">
                         <div id="image-upload-container" class="mb-3 hidden">
                            <div id="image-upload-area" class="p-5 text-center cursor-pointer hover:bg-gray-800 rounded-lg"><i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-500"></i><p class="text-gray-500 mt-2">Kéo thả ảnh hoặc click để chọn</p><input type="file" id="image-input" accept="image/*" class="hidden"></div>
                            <div id="image-preview-container" class="hidden mt-3"><div class="relative inline-block"><img id="image-preview" class="max-w-xs max-h-40 rounded-md"><button id="remove-image-btn" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-600 text-white rounded-full h-6 w-6 flex items-center justify-center font-bold text-lg">&times;</button></div></div>
                        </div>
                        <div class="flex gap-2">
                            <button id="toggle-image-upload" class="flex-shrink-0 flex items-center space-x-2 px-3 py-2 bg-gray-600 hover:bg-gray-700 text-gray-300 rounded-lg"><i class="fa-solid fa-image"></i><span id="toggle-text" class="hidden sm:inline">Thêm ảnh</span></button>
                            <input type="text" id="chat-input" placeholder="Hỏi AI..." class="flex-grow w-full px-4 py-2 rounded-lg input-field">
                            <button id="chat-send-btn" class="bg-indigo-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-800">Gửi</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // --- CONFIG ---
        const WEBHOOK_URL = 'https://aps.aibm.space/webhook/bd1';
        const USER_EMAIL = 'aibizmanager@gmail.com'; 
        // QUAN TRỌNG: Thay thế 'YOUR_GEMINI_API_KEY' bằng API Key của bạn
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; 

        // --- BASEROW API CONFIG ---
        const BASEROW_HOST = 'https://aibm.store';
        const BASEROW_TOKEN = 'VppDkJZikNBGWobtcWfmefao16lpAlmN';
        const TABLE_IDS = {
            product: '724', character: '745', segment: '784',
            campaign: '731', post: '746', task: '795',
            automated_logs: '744', user: '875'
        };

        // --- STATE MANAGEMENT ---
        let timeSeriesChartInstance = null, zaloSegmentsChartInstance = null;
        let isProcessing = false;
        let loadedTabs = new Set(); // Keep track of loaded data tabs to avoid re-fetching

        // --- DOM ELEMENTS CACHE ---
        const DOMElements = {
            viewLogin: document.getElementById('view-login'),
            viewApp: document.getElementById('view-app'),
            views: {
                chatbot: document.getElementById('view-chatbot'),
                dashboard: document.getElementById('view-dashboard'),
                'bai-viet': document.getElementById('view-bai-viet'),
                'dinh-ky': document.getElementById('view-dinh-ky')
            },
            tabs: {
                chatbot: document.getElementById('tab-chatbot'),
                dashboard: document.getElementById('tab-dashboard'),
                'bai-viet': document.getElementById('tab-bai-viet'),
                'dinh-ky': document.getElementById('tab-dinh-ky')
            },
            baiViet: {
                list: document.getElementById('bai-viet-list-view'),
                detail: document.getElementById('bai-viet-detail-view')
            },
            dinhKy: {
                list: document.getElementById('dinh-ky-list-view'),
                detail: document.getElementById('dinh-ky-detail-view')
            },
            chatbot: {
                messages: document.getElementById('chat-messages'),
                input: document.getElementById('chat-input'),
                sendBtn: document.getElementById('chat-send-btn'),
                imageArea: document.getElementById('image-upload-area'),
                imageInput: document.getElementById('image-input'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                imagePreview: document.getElementById('image-preview'),
                removeImageBtn: document.getElementById('remove-image-btn'),
                toggleImageBtn: document.getElementById('toggle-image-upload'),
                toggleImageText: document.getElementById('toggle-text'),
                imageUploadContainer: document.getElementById('image-upload-container')
            }
        };
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            addEventListeners();
            showView('login'); 
        });

        // --- EVENT LISTENERS ---
        function addEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => showView('login'));

            Object.keys(DOMElements.tabs).forEach(key => {
                DOMElements.tabs[key].addEventListener('click', () => switchMainView(key));
            });
            
            // Dashboard sub-tabs
            DOMElements.views.dashboard.addEventListener('click', (e) => {
                 if(e.target.matches('.dashboard-tab-btn')) {
                    switchDashboardTab(e.target.dataset.tab);
                 } else if (e.target.matches('#refresh-legacy-btn')) {
                    fetchLegacyDashboardData();
                 } else if (e.target.matches('.refresh-btn')) {
                    const tab = e.target.dataset.tab;
                    if(tab === 'product') renderProductTab(true);
                    if(tab === 'character') renderCharacterTab(true);
                    if(tab === 'segment') renderSegmentTab(true);
                 }
            });
            
            // Back buttons for detail views
            DOMElements.baiViet.detail.addEventListener('click', e => { if (e.target.matches('.back-to-list-btn')) showBaiVietView('list'); });
            DOMElements.dinhKy.detail.addEventListener('click', e => { if (e.target.matches('.back-to-list-btn')) showDinhKyView('list'); });

            // Chatbot listeners
            const cb = DOMElements.chatbot;
            cb.sendBtn.addEventListener('click', handleChatSubmit);
            cb.input.addEventListener('keyup', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChatSubmit(); }});
            cb.imageInput.addEventListener('change', (e) => handleImageFile(e.target.files[0]));
            cb.removeImageBtn.addEventListener('click', clearImage);
            cb.imageArea.addEventListener('dragover', (e) => { e.preventDefault(); cb.imageArea.classList.add('dragover'); });
            cb.imageArea.addEventListener('dragleave', (e) => { e.preventDefault(); cb.imageArea.classList.remove('dragover'); });
            cb.imageArea.addEventListener('drop', (e) => { e.preventDefault(); cb.imageArea.classList.remove('dragover'); if (e.dataTransfer.files[0]) handleImageFile(e.dataTransfer.files[0]); });
            cb.imageArea.addEventListener('click', () => cb.imageInput.click());
            cb.toggleImageBtn.addEventListener('click', () => {
                const isHidden = cb.imageUploadContainer.classList.toggle('hidden');
                cb.toggleImageText.textContent = isHidden ? 'Thêm ảnh' : 'Ẩn ảnh';
                if (isHidden) clearImage();
            });
        }

        // --- VIEW & NAVIGATION LOGIC ---
        function showView(viewName) {
            DOMElements.viewLogin.classList.add('hidden');
            DOMElements.viewApp.classList.add('hidden');
            if (viewName === 'login') {
                DOMElements.viewLogin.classList.remove('hidden');
            } else if (viewName === 'app') {
                DOMElements.viewApp.classList.remove('hidden');
            }
        }

        function switchMainView(viewName) {
            Object.values(DOMElements.views).forEach(v => v.classList.add('hidden'));
            Object.values(DOMElements.tabs).forEach(t => t.classList.remove('active'));
            
            DOMElements.views[viewName].classList.remove('hidden');
            DOMElements.tabs[viewName].classList.add('active');

            // Lazy load content
            if (!loadedTabs.has(viewName)) {
                switch (viewName) {
                    case 'dashboard':
                        renderProductTab(); // Render first sub-tab
                        fetchLegacyDashboardData();
                        break;
                    case 'bai-viet':
                        renderCampaignList();
                        break;
                    case 'dinh-ky':
                        renderTaskList();
                        break;
                }
                loadedTabs.add(viewName);
            }
             // Adjust main padding for chatbot view
            const mainElement = DOMElements.viewApp.querySelector('main');
            if (viewName === 'chatbot') {
                DOMElements.views[viewName].classList.add('flex');
                mainElement.style.padding = '0';
            } else {
                DOMElements.views.chatbot.classList.remove('flex');
                 mainElement.style.padding = '1.5rem';
            }
        }
        
        function switchDashboardTab(tabName) {
            const dashboardView = DOMElements.views.dashboard;
            dashboardView.querySelectorAll('.dashboard-tab-btn').forEach(button => {
                button.classList.toggle('active', button.dataset.tab === tabName);
            });
            dashboardView.querySelectorAll('.dashboard-tab-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== `dashboard-tab-content-${tabName}`);
            });

            // Lazy load tab content
            const tabId = `dashboard-${tabName}`;
            if (!loadedTabs.has(tabId)) {
                if(tabName === 'product') renderProductTab();
                else if(tabName === 'character') renderCharacterTab();
                else if(tabName === 'segment') renderSegmentTab();
                loadedTabs.add(tabId);
            }
        }

        // --- AUTHENTICATION ---
        async function handleLogin(e) {
            const loginBtn = e.target;
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorEl = document.getElementById('login-error');

            if (!email || !password) {
                errorEl.textContent = 'Vui lòng nhập email và mật khẩu.';
                errorEl.classList.remove('hidden');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Đang đăng nhập...';
            errorEl.classList.add('hidden');

            try {
                const url = `${BASEROW_HOST}/api/database/rows/table/${TABLE_IDS.user}/?user_field_names=true&filter__email__equal=${encodeURIComponent(email)}`;
                const { results } = await apiCall(url);
                
                if (results.length > 0 && results[0].pass === password) {
                    showView('app');
                    switchMainView('chatbot');
                } else {
                    errorEl.textContent = 'Email hoặc mật khẩu không chính xác.';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
                errorEl.classList.remove('hidden');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Đăng nhập';
            }
        }

        // --- API & DATA HANDLING ---
        async function apiCall(url, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Authorization': `Token ${BASEROW_TOKEN}`, 'Content-Type': 'application/json' }
            };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                console.error('Baserow API Error:', errorData);
                throw new Error(`API call failed: ${response.status}`);
            }
            return response.status === 204 ? null : response.json();
        }

        const getBaserowRows = (tableId) => apiCall(`${BASEROW_HOST}/api/database/rows/table/${tableId}/?user_field_names=true&filter__mail__equal=${USER_EMAIL}`);
        const addBaserowRow = (tableId, data) => apiCall(`${BASEROW_HOST}/api/database/rows/table/${tableId}/?user_field_names=true`, 'POST', { ...data, mail: USER_EMAIL });
        const deleteBaserowRow = (tableId, rowId) => apiCall(`${BASEROW_HOST}/api/database/rows/table/${tableId}/${rowId}/`, 'DELETE');
        const getBaserowRowsWithFilter = (tableId, field, value) => apiCall(`${BASEROW_HOST}/api/database/rows/table/${tableId}/?user_field_names=true&filter__${encodeURIComponent(field)}__equal=${encodeURIComponent(value)}`);

        // --- RENDERING FUNCTIONS ---
        // Generic function to set up form and delete listeners
        function setupEventListenersForTable(container, tableId, reRenderCallback) {
            // Form submission
            container.querySelector('form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                // Simple validation: check if first input is filled
                if (Object.values(data)[0].trim()) {
                    try {
                        const payload = {};
                        // Map form names to Baserow field names
                        if(tableId === TABLE_IDS.product) { payload.name = data.name; payload.SKU = data.sku; }
                        else if (tableId === TABLE_IDS.character) { payload.Name = data.name; payload.Notes = data.notes; }
                        else if (tableId === TABLE_IDS.segment) { payload.Name = data.name; payload.Notes = data.notes; }
                        else if (tableId === TABLE_IDS.campaign) { payload['chủ đề, tiêu đề'] = data['campaign-name']; }
                        else if (tableId === TABLE_IDS.task) { 
                            payload.input = data['task-input'];
                            payload['Loại nhiệm vụ'] = [{ id: parseInt(data['task-frequency']) }];
                        }
                        
                        await addBaserowRow(tableId, payload);
                        form.reset();
                        await reRenderCallback(true);
                    } catch (error) {
                         alert(`Lỗi: Không thể thêm mục mới. ${error.message}`);
                    }
                }
            });

            // Delete button clicks
            container.querySelector('tbody')?.addEventListener('click', async (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) {
                    const rowId = deleteButton.dataset.rowId;
                    if (confirm('Bạn có chắc muốn xóa mục này?')) {
                        try {
                            await deleteBaserowRow(tableId, rowId);
                            await reRenderCallback(true);
                        } catch (error) {
                            alert('Lỗi: Không thể xóa mục này.');
                        }
                    }
                }
            });
        }

        // --- DASHBOARD RENDERING ---
        async function fetchLegacyDashboardData() {
            const container = document.getElementById('legacy-dashboard-content');
            container.innerHTML = `<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-4xl text-indigo-400"></i><p class="mt-4 text-gray-400">Đang tải dữ liệu dashboard...</p></div>`;
            try {
                const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ "task": "dashboard", "email": USER_EMAIL }) });
                if (!response.ok) throw new Error(`Webhook error: ${response.status}`);
                const data = await response.json();
                renderLegacyDashboard(data);
            } catch (error) {
                console.error("Dashboard fetch error:", error);
                container.innerHTML = `<p class="text-red-400 text-center">Không thể tải dữ liệu kênh.</p>`;
            }
        }
        
        function renderLegacyDashboard(data){
            const container = document.getElementById('legacy-dashboard-content');
             const sumBy = (arr, prop) => Array.isArray(arr) ? arr.reduce((sum, row) => sum + (Number(row[prop]) || 0), 0) : 0;
            const wpData = data.wp || [], fbData = data.fb || [], ttData = data.tt || [], zlLogData = data['zl log'] || [], segmentData = data.segment || data['zl pro5'] || [];

            container.innerHTML = `
                <div class="flex items-center mb-4">
                    <h3 class="text-lg font-semibold text-white">Hiệu suất theo ngày</h3>
                    <button id="refresh-legacy-btn" class="ml-4 px-3 py-1 bg-gray-600 hover:bg-gray-700 text-sm rounded-md"><i class="fa-solid fa-sync mr-2"></i>Làm mới</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                    <div class="card p-5"><p class="text-sm text-gray-400">Wordpress Reach</p><p class="text-2xl font-bold">${sumBy(wpData, 'reach').toLocaleString('vi-VN')}</p></div>
                    <div class="card p-5"><p class="text-sm text-gray-400">Fanpage Reach</p><p class="text-2xl font-bold">${sumBy(fbData, 'reach').toLocaleString('vi-VN')}</p></div>
                    <div class="card p-5"><p class="text-sm text-gray-400">TikTok Views</p><p class="text-2xl font-bold">${sumBy(ttData, 'views').toLocaleString('vi-VN')}</p></div>
                    <div class="card p-5"><p class="text-sm text-gray-400">Zalo Sent</p><p class="text-2xl font-bold">${sumBy(zlLogData, 'sent').toLocaleString('vi-VN')}</p></div>
                    <div class="card p-5"><p class="text-sm text-gray-400">Zalo Users</p><p class="text-2xl font-bold">${(segmentData.length || 0).toLocaleString('vi-VN')}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 card p-6"><div class="h-80"><canvas id="timeSeriesChart"></canvas></div></div>
                    <div class="card p-6"><h3 class="text-lg font-semibold text-white mb-4">Phân khúc Zalo Users</h3><div class="h-80"><canvas id="zaloSegmentsChart"></canvas></div></div>
                </div>`;
            
            // Render Charts
            Chart.defaults.color = 'white'; Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
            const allDates = [...new Set([...wpData.map(d => d.date.split(' ')[0]), ...fbData.map(d => d.date.split(' ')[0]), ...ttData.map(d => d.date.split(' ')[0])])].sort();
            const datasets = [
                { label: 'Wordpress', data: allDates.map(date => wpData.find(d => d.date.startsWith(date))?.reach || 0), borderColor: '#3b82f6' },
                { label: 'Facebook', data: allDates.map(date => fbData.find(d => d.date.startsWith(date))?.reach || 0), borderColor: '#8b5cf6' },
                { label: 'TikTok', data: allDates.map(date => ttData.find(d => d.date.startsWith(date))?.views || 0), borderColor: '#ec4899' }
            ];
            if (timeSeriesChartInstance) timeSeriesChartInstance.destroy();
            timeSeriesChartInstance = new Chart(document.getElementById('timeSeriesChart').getContext('2d'), { type: 'line', data: { labels: allDates, datasets: datasets.map(ds => ({ ...ds, fill: false, tension: 0.4, borderWidth: 2 })) }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: {} } } });
            
            const segmentCounts = segmentData.reduce((acc, user) => { acc[user.segment] = (acc[user.segment] || 0) + 1; return acc; }, {});
            if (zaloSegmentsChartInstance) zaloSegmentsChartInstance.destroy();
            zaloSegmentsChartInstance = new Chart(document.getElementById('zaloSegmentsChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(segmentCounts), datasets: [{ data: Object.values(segmentCounts), backgroundColor: [ '#4f46e5', '#3b82f6', '#0ea5e9', '#64748b' ] }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
        
        async function renderProductTab(force = false) {
             if (!force && loadedTabs.has('dashboard-product')) return;
            const container = document.getElementById('dashboard-tab-content-product');
            container.innerHTML = `<div class="text-center p-4">Đang tải...</div>`;
            try {
                const { results } = await getBaserowRows(TABLE_IDS.product);
                container.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                      <h4 class="text-md font-semibold text-white">Thêm sản phẩm mới</h4>
                      <button data-tab="product" class="refresh-btn px-3 py-1 bg-gray-600 hover:bg-gray-700 text-sm rounded-md"><i class="fa-solid fa-sync mr-2"></i>Làm mới</button>
                    </div>
                    <form class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <input type="text" name="name" placeholder="Tên sản phẩm" class="w-full px-3 py-2 rounded-md input-field" required>
                         <input type="text" name="sku" placeholder="SKU" class="w-full px-3 py-2 rounded-md input-field">
                         <button type="submit" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md">Thêm</button>
                    </form>
                    <div class="overflow-x-auto mt-4">
                         <table class="w-full text-left text-sm table-auto">
                             <thead class="bg-gray-700 text-gray-300"><tr><th class="p-2">Tên sản phẩm</th><th class="p-2">SKU</th><th class="p-2">Ngày tạo</th><th class="p-2">Hành động</th></tr></thead>
                             <tbody>
                                ${results.map(row => `
                                    <tr>
                                        <td class="p-2">${row.name || ''}</td><td class="p-2">${row.SKU || ''}</td>
                                        <td class="p-2">${new Date(row['Created on']).toLocaleDateString('vi-VN')}</td>
                                        <td class="p-2"><button class="text-red-400 delete-btn" data-row-id="${row.id}"><i class="fa-solid fa-trash"></i></button></td>
                                    </tr>`).join('')}
                             </tbody>
                         </table>
                    </div>`;
                setupEventListenersForTable(container, TABLE_IDS.product, renderProductTab);
                loadedTabs.add('dashboard-product');
            } catch (error) { container.innerHTML = `<div class="text-center p-4 text-red-400">Lỗi tải dữ liệu.</div>`; }
        }
        
        async function renderCharacterTab(force = false) {
             if (!force && loadedTabs.has('dashboard-character')) return;
            const container = document.getElementById('dashboard-tab-content-character');
            container.innerHTML = `<div class="text-center p-4">Đang tải...</div>`;
            try {
                const { results } = await getBaserowRows(TABLE_IDS.character);
                 container.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                      <h4 class="text-md font-semibold text-white">Thêm Character mới</h4>
                       <button data-tab="character" class="refresh-btn px-3 py-1 bg-gray-600 hover:bg-gray-700 text-sm rounded-md"><i class="fa-solid fa-sync mr-2"></i>Làm mới</button>
                    </div>
                     <form class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <input type="text" name="name" placeholder="Tên Character" class="w-full px-3 py-2 rounded-md input-field" required>
                         <input type="text" name="notes" placeholder="Mô tả" class="w-full px-3 py-2 rounded-md input-field">
                         <button type="submit" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md">Thêm</button>
                     </form>
                     <div class="overflow-x-auto mt-4">
                         <table class="w-full text-left text-sm table-auto">
                              <thead class="bg-gray-700 text-gray-300"><tr><th class="p-2">Tên Character</th><th class="p-2">Mô tả</th><th class="p-2">Hành động</th></tr></thead>
                              <tbody>
                                 ${results.map(row => `<tr><td class="p-2">${row.Name || ''}</td><td class="p-2">${row.Notes || ''}</td><td class="p-2"><button class="text-red-400 delete-btn" data-row-id="${row.id}"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('')}
                              </tbody>
                         </table>
                     </div>`;
                setupEventListenersForTable(container, TABLE_IDS.character, renderCharacterTab);
                loadedTabs.add('dashboard-character');
            } catch (error) { container.innerHTML = `<div class="text-center p-4 text-red-400">Lỗi tải dữ liệu.</div>`; }
        }

        async function renderSegmentTab(force = false) {
             if (!force && loadedTabs.has('dashboard-segment')) return;
            const container = document.getElementById('dashboard-tab-content-segment');
            container.innerHTML = `<div class="text-center p-4">Đang tải...</div>`;
            try {
                const { results } = await getBaserowRows(TABLE_IDS.segment);
                 container.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                         <h4 class="text-md font-semibold text-white">Thêm Segment - Channel mới</h4>
                         <button data-tab="segment" class="refresh-btn px-3 py-1 bg-gray-600 hover:bg-gray-700 text-sm rounded-md"><i class="fa-solid fa-sync mr-2"></i>Làm mới</button>
                    </div>
                     <form class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                         <input type="text" name="name" placeholder="Tên Segment" class="w-full px-3 py-2 rounded-md input-field" required>
                         <input type="text" name="notes" placeholder="Kênh" class="w-full px-3 py-2 rounded-md input-field">
                         <button type="submit" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md">Thêm</button>
                     </form>
                     <div class="overflow-x-auto mt-4">
                         <table class="w-full text-left text-sm table-auto">
                              <thead class="bg-gray-700 text-gray-300"><tr><th class="p-2">Segment</th><th class="p-2">Channel</th><th class="p-2">Hành động</th></tr></thead>
                              <tbody>
                                 ${results.map(row => `<tr><td class="p-2">${row.Name || ''}</td><td class="p-2">${row.Notes || ''}</td><td class="p-2"><button class="text-red-400 delete-btn" data-row-id="${row.id}"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('')}
                              </tbody>
                         </table>
                     </div>`;
                 setupEventListenersForTable(container, TABLE_IDS.segment, renderSegmentTab);
                 loadedTabs.add('dashboard-segment');
            } catch (error) { container.innerHTML = `<div class="text-center p-4 text-red-400">Lỗi tải dữ liệu.</div>`; }
        }

        // --- ARTICLES (BÀI VIẾT) RENDERING ---
        function showBaiVietView(view) {
            DOMElements.baiViet.list.classList.toggle('hidden', view !== 'list');
            DOMElements.baiViet.detail.classList.toggle('hidden', view !== 'detail');
        }

        async function renderCampaignList(force = false) {
             if (!force && loadedTabs.has('bai-viet-list')) return;
            const container = DOMElements.baiViet.list;
            container.innerHTML = `<p class="p-4 text-center">Đang tải...</p>`;
            try {
                const { results } = await getBaserowRows(TABLE_IDS.campaign);
                container.innerHTML = `
                    <h1 class="text-3xl font-bold text-white mb-6">Bài viết</h1>
                    <div class="card p-6 rounded-lg mb-6">
                        <form id="add-campaign-form">
                            <input type="text" name="campaign-name" class="input-field w-full rounded-md p-3" placeholder="Nhập tên chiến dịch mới..." required>
                            <button type="submit" class="mt-4 w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white rounded-md px-6 py-3 font-semibold"><i class="fas fa-plus mr-2"></i>Tạo Chiến dịch</button>
                        </form>
                    </div>
                    <div class="card rounded-lg overflow-hidden">
                        <div id="campaign-list" class="space-y-1 p-2">
                             ${results.length === 0 ? '<p class="p-4 text-center text-gray-400">Chưa có chiến dịch nào.</p>' : results.map(c => `
                                <div class="list-item p-4 rounded-lg" data-campaign-name="${c['chủ đề, tiêu đề']}">
                                    <h3 class="font-bold text-white pointer-events-none">${c['chủ đề, tiêu đề']}</h3>
                                    <p class="text-sm text-gray-400 pointer-events-none">${c.number || 0} bài viết</p>
                                </div>`).join('')}
                        </div>
                    </div>`;
                
                document.getElementById('add-campaign-form').addEventListener('submit', async (e) => {
                     e.preventDefault();
                     const campaignName = e.target.querySelector('input[name="campaign-name"]').value.trim();
                     if (campaignName) {
                        await addBaserowRow(TABLE_IDS.campaign, { 'chủ đề, tiêu đề': campaignName });
                        e.target.reset();
                        await renderCampaignList(true);
                     }
                });

                document.getElementById('campaign-list').addEventListener('click', (e) => {
                    const campaignItem = e.target.closest('.list-item');
                    if(campaignItem) {
                        renderPostList(campaignItem.dataset.campaignName);
                    }
                });
                loadedTabs.add('bai-viet-list');
            } catch(e) { container.innerHTML = `<p class="p-4 text-center text-red-400">Lỗi tải chiến dịch.</p>`; }
        }

        async function renderPostList(campaignName) {
            showBaiVietView('detail');
            const container = DOMElements.baiViet.detail;
            container.innerHTML = `<p class="text-center">Đang tải bài viết...</p>`;
            try {
                const { results } = await getBaserowRowsWithFilter(TABLE_IDS.post, 'camp name', campaignName);
                container.innerHTML = `
                    <button class="back-to-list-btn mb-4 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-700 text-white"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                    <h2 class="text-2xl font-bold text-white mb-4">Chiến dịch: ${campaignName}</h2>
                    <div class="space-y-4">
                        ${results.length === 0 ? '<p class="p-4 text-center text-gray-400">Chưa có bài viết nào.</p>' : results.map(post => {
                            const isPublished = post.time && new Date(post.time.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3')) < new Date();
                            const statusClass = isPublished ? 'status-published' : 'status-draft';
                            const statusText = isPublished ? 'Đã đăng' : 'Chưa đăng';
                            const timeValue = post.time ? new Date(post.time.replace(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}:\d{2})/, '$3-$2-$1T$4')).toISOString().substring(0, 16) : '';
                            return `<div class="card p-4">
                                        <p class="font-semibold text-white">${post['tiêu đề']}</p>
                                        <div class="mt-2 flex justify-between items-center">
                                            <span class="status-badge ${statusClass}">${statusText}</span>
                                            <input type="datetime-local" class="input-field text-sm p-1 rounded-md bg-gray-700 border-gray-600" value="${timeValue}">
                                        </div>
                                    </div>`;
                        }).join('')}
                    </div>`;
            } catch(e) { container.innerHTML = `<p class="text-center text-red-400">Lỗi tải bài viết.</p>`; }
        }

        // --- RECURRING (ĐỊNH KỲ) RENDERING ---
        function showDinhKyView(view) {
            DOMElements.dinhKy.list.classList.toggle('hidden', view !== 'list');
            DOMElements.dinhKy.detail.classList.toggle('hidden', view !== 'detail');
        }

        async function renderTaskList(force = false) {
             if (!force && loadedTabs.has('dinh-ky-list')) return;
            const container = DOMElements.dinhKy.list;
            container.innerHTML = `<p class="p-4 text-center">Đang tải...</p>`;
             try {
                const { results } = await getBaserowRows(TABLE_IDS.task);
                container.innerHTML = `
                    <h1 class="text-3xl font-bold text-white mb-6">Định kỳ</h1>
                     <div class="card p-6 rounded-lg mb-6">
                         <h2 class="text-xl font-semibold mb-2 text-white">Thêm nhiệm vụ theo dõi Website</h2>
                         <form id="add-task-form" class="flex flex-col sm:flex-row gap-4 mt-4">
                             <input name="task-input" class="input-field flex-grow p-3 rounded-md" placeholder="https://www.example.com/news" required>
                             <select name="task-frequency" class="input-field p-3 rounded-md">
                                <option value="3270">Hàng ngày</option><option value="3271">Hàng tuần</option>
                             </select>
                             <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-md">Thêm</button>
                         </form>
                    </div>
                    <div class="card rounded-lg overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700"><tr class="bg-gray-700"><th scope="col" class="p-4 font-semibold text-gray-300">Nhiệm vụ</th><th scope="col" class="p-4 font-semibold text-gray-300">Tần suất</th><th scope="col" class="p-4 font-semibold text-gray-300">Trạng thái</th></tr></thead>
                            <tbody id="task-list-body" class="divide-y divide-gray-700">
                               ${results.length === 0 ? '<tr><td colspan="3" class="p-4 text-center text-gray-400">Chưa có nhiệm vụ nào.</td></tr>' : results.map(task => `
                                    <tr class="list-item" data-task-input="${task.input}">
                                        <td class="p-4 truncate pointer-events-none">${task.input}</td>
                                        <td class="p-4 pointer-events-none">${task['Loại nhiệm vụ']?.value || 'Không xác định'}</td>
                                        <td class="p-4 pointer-events-none"><span class="font-semibold text-green-400">Hoạt động</span></td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;

                 document.getElementById('add-task-form').addEventListener('submit', async (e) => {
                     e.preventDefault();
                     const input = e.target.querySelector('input[name="task-input"]').value.trim();
                     const freqId = e.target.querySelector('select[name="task-frequency"]').value;
                     if(input) {
                        await addBaserowRow(TABLE_IDS.task, { 'input': input, 'Loại nhiệm vụ': [{ id: parseInt(freqId) }] });
                        e.target.reset();
                        await renderTaskList(true);
                     }
                 });

                 document.getElementById('task-list-body').addEventListener('click', e => {
                    const taskItem = e.target.closest('.list-item');
                    if(taskItem) renderTaskLogs(taskItem.dataset.taskInput);
                 });
                 loadedTabs.add('dinh-ky-list');
             } catch(e) { container.innerHTML = `<p class="p-4 text-center text-red-400">Lỗi tải nhiệm vụ.</p>`; }
        }

        async function renderTaskLogs(taskInput) {
            showDinhKyView('detail');
            const container = DOMElements.dinhKy.detail;
            container.innerHTML = `<p class="text-center">Đang tải logs...</p>`;
            try {
                const { results } = await getBaserowRowsWithFilter(TABLE_IDS.automated_logs, 'task', taskInput);
                container.innerHTML = `
                    <button class="back-to-list-btn mb-4 py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-700 text-white"><i class="fas fa-arrow-left mr-2"></i> Quay lại</button>
                    <h2 class="text-2xl font-bold text-white mb-4">Logs cho: ${taskInput}</h2>
                    <div class="space-y-4">
                        ${results.length === 0 ? '<p class="p-4 text-center text-gray-400">Chưa có log nào.</p>' : results.map(log => {
                            const logDate = new Date(log['Created on']).toLocaleString('vi-VN');
                            const statusText = log.Name.includes("mới") ? `<span class="text-green-400">Hoàn thành</span>` : `<span class="text-gray-400">Không có gì mới</span>`;
                            return `<div class="card p-3"><p class="text-sm text-gray-400">${logDate} - ${statusText}</p><p class="text-white mt-1">${log.Name}</p></div>`;
                        }).join('')}
                    </div>`;
            } catch(e) { container.innerHTML = `<p class="text-center text-red-400">Lỗi tải logs.</p>`; }
        }

        // --- CHATBOT LOGIC ---
        async function handleChatSubmit() {
            const userInput = DOMElements.chatbot.input.value.trim();
            const imageFile = DOMElements.chatbot.imageInput.files[0];
            if ((!userInput && !imageFile) || isProcessing) return;

            setLoadingState(true);
            DOMElements.chatbot.input.value = '';

            if (imageFile) {
                const prompt = userInput || "Phân tích ảnh này.";
                appendChatMessage(`*Gửi ảnh...*`, 'user');
                if(userInput) appendChatMessage(userInput, 'user');
                showTypingIndicator(true);
                await handleImageAnalysis(imageFile, prompt);
            } else {
                appendChatMessage(userInput, 'user');
                showTypingIndicator(true);
                await handleTextChat(userInput);
            }
            
            clearImage();
            setLoadingState(false);
            DOMElements.chatbot.input.focus();
        }

        async function handleTextChat(userInput) {
            try {
                const response = await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task: "chatbot", prompt: userInput, threadId: "digital-chat", email: USER_EMAIL }) });
                if (!response.ok) throw new Error(`Webhook error: ${response.status}`);
                const result = await response.json();
                appendChatMessage(result[0]?.output || "Lỗi, không có phản hồi.", 'ai');
            } catch (error) {
                appendChatMessage(`**Lỗi:** ${error.message}`, 'ai');
            }
        }

        async function handleImageAnalysis(file, userInput) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                appendChatMessage("**Lỗi:** Vui lòng cấu hình `GEMINI_API_KEY` trong code để sử dụng chức năng này.", 'ai');
                return;
            }
            try {
                const base64Image = await fileToBase64(file);
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: userInput }, { inline_data: { mime_type: file.type, data: base64Image.split(',')[1] } }] }] })
                });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content.parts[0].text || 'Không nhận được phản hồi.';
                appendChatMessage(aiResponse, 'ai');
            } catch (error) {
                appendChatMessage("**Lỗi phân tích ảnh:** " + error.message, 'ai');
            }
        }

        function showTypingIndicator(show) {
            let indicator = document.getElementById('typing-indicator');
            if (show) {
                if (indicator) indicator.remove();
                indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'flex justify-start';
                indicator.innerHTML = `<div class="chat-bubble-ai p-3 rounded-lg flex items-center space-x-1"><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div></div>`;
                DOMElements.chatbot.messages.appendChild(indicator);
                DOMElements.chatbot.messages.scrollTop = DOMElements.chatbot.messages.scrollHeight;
            } else {
                if (indicator) indicator.remove();
            }
        }

        function appendChatMessage(message, sender) {
            showTypingIndicator(false);
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            // Add prose-invert for better markdown styling on dark bg
            bubble.className = `p-3 rounded-lg max-w-lg prose prose-invert ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'}`;
            bubble.innerHTML = marked.parse(message);
            wrapper.appendChild(bubble);
            DOMElements.chatbot.messages.appendChild(wrapper);
            DOMElements.chatbot.messages.scrollTop = DOMElements.chatbot.messages.scrollHeight;
        }

        function handleImageFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => { DOMElements.chatbot.imagePreview.src = e.target.result; DOMElements.chatbot.imagePreviewContainer.classList.remove('hidden'); }
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            DOMElements.chatbot.imageInput.value = '';
            DOMElements.chatbot.imagePreviewContainer.classList.add('hidden');
            DOMElements.chatbot.imagePreview.src = '';
        }

        const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = reject; });
        
        function setLoadingState(isLoading) {
            isProcessing = isLoading;
            DOMElements.chatbot.sendBtn.disabled = isLoading;
            DOMElements.chatbot.input.disabled = isLoading;
        }
    </script>
</body>
</html>



